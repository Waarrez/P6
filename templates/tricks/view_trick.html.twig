{% extends 'base.html.twig' %}

{% block title trick.name %}

{% block body %}

    <div class="text-center">
        <p style="position:absolute;font-size: 150px; color: black; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%);">{{ trick.name }}</p>
        <img width="100%" src="{{ asset('uploads/tricksImg/' ~ trick.images) }}" alt="Trick Image" onerror="this.src='{{ asset('img/default-picture.png') }}'">
    </div>

    {% if trick.medias %}
        <div class="mt-5 d-flex align-items-center justify-content-around">
            <iframe width="560" height="315" src="{{ trick.medias }}" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            {% if trick.imagesTrick %}
                {% for imagesTrick in trick.imagesTrick %}
                    <img width="20%" src="{{ asset('uploads/tricksImg/' ~ imagesTrick.name) }}" alt="Trick Additional Image" onerror="this.src='{{ asset('img/default-picture.png') }}'">
                {% endfor %}
            {% endif %}
        </div>
    {% endif %}

    <div class="container mt-5 mb-5 d-flex justify-content-around align-items-center">
        <span class="badge bg-primary">{{ trick.groups.name }}</span>
        <span class="badge bg-primary">Crée le {{ trick.createdAt|date('d-m-Y') }}</span>
        <span class="badge bg-primary">Modifié le {{ trick.editAt|date('d-m-Y') }}</span>
    </div>

    <div class="d-flex justify-content-center align-items-center flex-column mb-5">
        <hr style="width: 50%; ">

        <div class="col-md-6">
            {% for message in app.flashes('success') %}
                <div class="alert alert-success">
                    {{ message }}
                </div>
            {% endfor %}

            <h2 class="text-center mt-5 mb-5">Ecrire un commentaire</h2>
            {% if app.user %}
                <form class="d-flex align-items-center p-3 mt-5" id="commentForm">
                    <input id="content" type="text" class="form-control">
                    <button class="btn btn-primary">Envoyer</button>
                </form>
            {% else %}
                <div class="container">
                    <div class="alert alert-warning">
                        Vous devez être connecté pour écrire un commentaire
                    </div>
                </div>
            {% endif %}
        </div>

        <hr class="mt-5" style="width: 50%; ">
    </div>

    <div style="width: 50%" class="container mt-5 mb-5" id="commentaires">
        {% for comment in comments %}
            <div class="d-flex align-items-center gap-5 mt-5 w-100" style="background-color: #f7f7f9">
                <img class="rounded-circle" width="5%" src="{{ comment.users.userPicture ? asset('uploads/pictures/' ~ comment.users.userPicture) : asset('img/default-picture.png') }}" alt="User Avatar" onerror="this.src='{{ asset('img/default-picture.png') }}'">
                <span class="badge bg-dark">{{ comment.users.username }}</span>
                <p style="margin-left: 100px; margin-bottom: 0">{{ comment.content }}</p>
                <span class="badge bg-dark ms-auto">Posté le {{ comment.createdAt|date('Y-m-d') }}</span>
            </div>
        {% endfor %}
    </div>

    {% if comments|length > 3 %}
        <div class="d-flex justify-content-center align-items-center">
            <button id="loadComment" class="btn btn-outline-primary mt-5 mb-5">Charger plus</button>
        </div>
    {% endif %}

    <script type="module">
        let url = window.location.href;
        let slugMatches = url.match(/\/trick\/detail\/([^\/]+)$/);
        let slug = slugMatches && slugMatches[1];

        document.getElementById('commentForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const content = document.getElementById('content').value.trim();

            if (content === '') {
                alert('Veuillez entrer un commentaire.');
                return;
            }

            let xhttp = new XMLHttpRequest();

            xhttp.onreadystatechange = function() {
                if (this.readyState === 4 && this.status === 200) {
                    let response = JSON.parse(this.responseText);
                    let newComments = response.comments;

                    let commentairesDiv = document.getElementById('commentaires');
                    commentairesDiv.innerHTML = '<div class="alert alert-success">Votre commentaire a bien été ajouté !</div>';

                    newComments.forEach(function(comment) {
                        let newCommentDiv = document.createElement('div');
                        newCommentDiv.classList.add('d-flex', 'align-items-center', 'gap-5', 'mt-5');
                        newCommentDiv.style.backgroundColor = '#f7f7f9';

                        let imgSrc = comment.userPicture && comment.userPicture !== ""
                            ? '/uploads/pictures/' + comment.userPicture
                            : '/img/default-picture.png';

                        newCommentDiv.innerHTML = `
                            <img class="rounded-circle" width="5%" src="${imgSrc}" alt="Avatar" onerror="this.src='/img/default-picture.png'">
                            <span class="badge bg-dark">${comment.username}</span>
                            <p style="margin-left: 100px; margin-bottom: 0">${comment.content}</p>
                        `;

                        commentairesDiv.appendChild(newCommentDiv);
                    });
                }
            };

            xhttp.open('POST', '/add-comment', true);
            xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            xhttp.send('slug=' + slug + '&content=' + content);
        });

        let comments = document.getElementsByClassName("comments");
        let buttonShow = document.getElementById("loadComment");

        buttonShow.addEventListener('click', () => {
            for (let i = 0; i < comments.length; i++) {
                comments[i].removeAttribute("id");
            }
            buttonShow.classList.add("noneButton");
        });
    </script>
{% endblock %}
